---
title: "ASPE - Préparation des données pour le package"
author: "Pascal Irz"
date: "`r format(Sys.time(), 'Le %d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(aspe)
```

## Objectif

Il s'agit ici de préparer des données sur les espèces qui seront incluses dans le package :

- Table passerelle entre codes taxonomiques Taxref, Sandre et Aspe
- Traits biologiques
- Statut listes rouges

## Données Aspe

On charge ici toutes les tables de la base Aspe à l'exception de `mesure_individuelle`. On s'intéressera en particulier aux tables `lot_poissons` pour identifier les espèces présentes dans les échantillons et `ref_espece` qui fait la correspondance entre codes Aspe à trois lettres, code sandre et nom latin. 

```{r}
load(file = "../../aspe_demo/raw_data/toutes_tables_aspe_sauf_mei.RData")
```

Collecte d'un vecteur caractère contenant les codes en trois lettres des taxons présents dans les échantillons.

```{r}
mes_especes <- lot_poissons %>% 
  rename(esp_id = lop_esp_id) %>% 
  left_join(y = ref_espece %>% 
              select(esp_id, esp_code_alternatif)) %>% 
  pull(esp_code_alternatif) %>% 
  unique()
```

## Correspondance codes taxonomiques

Opération un peu chronophage car télécharge tout TAXREF.

```{r}
passerelle_taxo <- imp_corres_aspe_taxref() %>%
  mutate(esp_code_taxref = as.integer(esp_code_taxref))
```

Gestion de quelques cas à problème comme les carpes (ex : CCO) qui n'ont pas de code Taxref proposé. Leurs codes ont été collectées "à la main" depuis la page de chaque espèce sur l'INPN, par exemple [https://inpn.mnhn.fr/espece/cd_nom/69772](https://inpn.mnhn.fr/espece/cd_nom/69772) pour le mulet à grosse tête.

```{r}
passerelle_taxo <- passerelle_taxo %>%
  left_join(y = ref_espece %>% 
              select(esp_id,
                     esp_code_alternatif,
                     esp_nom_latin)) %>% 
  mutate(
    esp_code_taxref = case_when(
      is.na(esp_code_taxref) & esp_nom_latin == "Cyprinus carpio" ~ 67058,
      is.na(esp_code_taxref) & esp_code_alternatif == "GFL" ~ 70166,
      is.na(esp_code_taxref) & esp_code_alternatif == "MUC" ~ 69772,
      is.na(esp_code_taxref) & esp_code_alternatif == "CAA" ~ 67208,
      TRUE ~ as.double(esp_code_taxref)
    )
  )
```
## Importation des statuts listes rouges

Les données sont téléchargées depuis [https://inpn.mnhn.fr/espece/listerouge/fr/poissons_eau_douce_metropole_2019](https://inpn.mnhn.fr/espece/listerouge/fr/poissons_eau_douce_metropole_2019).

```{r}
liste_rouge <- read_csv2("../raw_data/Liste rouge des poissons d'eau douce de France métropolitaine (2019)_202173.csv") %>% 
  rename(esp_code_taxref = CD_REF)
```

Pour une procédure plus automatique on peut aussi charger ces données depuis l'API liste rouge :

- Demander un jeton (*token*) permettant d'interroger l'API liste rouge depuis l'adresse [https://apiv3.iucnredlist.org/api/v3/token](https://apiv3.iucnredlist.org/api/v3/token).
- Charger les données au moyen du package `rredlist`.

## Traits poissons

Ce tableau a été constitué "à la main" par T. Oberdorff (IRD) et T. Vigneron (OFB). Il reste perfectible.

```{r}
traits_bio <- readxl::read_xlsx("../raw_data/traits_bio.xlsx")

traits_bio %>% DT::datatable()
```


## Sauvegarde

```{r}
save(passerelle_taxo, file = "../processed_data/passerelle_taxo.RData")
save(liste_rouge, file = "../processed_data/liste_rouge.RData")
save(traits_bio, file = "../processed_data/traits_bio.RData")
```

